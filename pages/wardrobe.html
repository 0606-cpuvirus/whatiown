<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What I Own - My Wardrobe</title>
    <link rel="stylesheet" href="../css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <script src="../js/app.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <h3>What I Own</h3>
        </div>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="wardrobe.html" class="active">Wardrobe</a>
            <a href="add-item.html">Add Item</a>
            <a href="generate-outfit.html">Generate</a>
            <a href="profile-settings.html">Profile</a>
        </div>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>My Wardrobe</h1>
            <a href="add-item.html"
                style="background: var(--accent-color); color: #000; padding: 8px 16px; border-radius: 4px; font-weight: bold;">+
                Add Item</a>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="filter-category">
                    <option value="">All Categories</option>
                </select>
                <select id="filter-season">
                    <option value="">All Seasons</option> <!-- Appwrite schema index needed? -->
                    <!-- Note: Wardrobe Items don't have explicit 'season' field in schema, they have warmthLevel. 
                         OutfitContexts have season. 
                         We can filter by warmthLevel as proxy or just Category. 
                         Schema: warmthLevel (light/medium/heavy). 
                    -->
                    <option value="light">Light (Summer)</option>
                    <option value="medium">Medium (Spring/Autumn)</option>
                    <option value="heavy">Heavy (Winter)</option>
                </select>
                <button id="apply-filters" style="width: auto;">Apply Filters</button>
            </div>
        </div>

        <div id="wardrobe-grid" class="grid">
            <p>Loading items...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const grid = document.getElementById('wardrobe-grid');
            const filterCategory = document.getElementById('filter-category');
            const filterSeason = document.getElementById('filter-season');
            const applyBtn = document.getElementById('apply-filters');

            // Wait Appwrite
            const checkAppwrite = setInterval(async () => {
                if (window.appwriteService && window.appwriteInitialized) {
                    clearInterval(checkAppwrite);
                    initPage();
                } else if (window.appwriteService) {
                    // Fallback check
                    clearInterval(checkAppwrite);
                    initPage();
                }
            }, 100);

            async function initPage() {
                // Populate Filters
                if (window.ENUMS) {
                    Object.values(window.ENUMS.CATEGORIES).forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat;
                        opt.innerText = cat.charAt(0).toUpperCase() + cat.slice(1);
                        filterCategory.appendChild(opt);
                    });
                }

                loadItems();
            }

            async function loadItems() {
                try {
                    grid.innerHTML = '<p>Loading...</p>';
                    const user = await window.appwriteService.getCurrentUser();
                    if (!user) {
                        window.location.href = '../index.html';
                        return;
                    }

                    const filters = {};
                    if (filterCategory.value) filters.category = filterCategory.value;
                    if (filterSeason.value) filters.warmthLevel = filterSeason.value;

                    const result = await window.appwriteService.listWardrobeItems(user.$id, filters);

                    if (result.total === 0) {
                        grid.innerHTML = '<p>No items found. <a href="add-item.html">Add some!</a></p>';
                        return;
                    }

                    grid.innerHTML = '';
                    result.documents.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'card';

                        // Image Handling
                        let imgHtml = '';
                        if (item.imageUrl) {
                            imgHtml = `<img src="${item.imageUrl}" alt="${item.itemName}">`;
                        } else if (item.imageFileId) {
                            // Construct view URL if missing
                            const url = \`https://sgp.cloud.appwrite.io/v1/storage/buckets/wardrobe_assets/files/\${item.imageFileId}/view?project=${window.appwriteService.client.config.project}\`;
                             imgHtml = `< img src = "${url}" alt = "${item.itemName}" > `;
                        } else {
                             imgHtml = `< div style = "height: 200px; background: #333; display: flex; align-items: center; justify-content: center;" > No Image</div > `;
                        }

                        card.innerHTML = `
                            ${ imgHtml }
                            <h4>${item.itemName}</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9em;">${item.category} â€¢ ${item.brand || 'No Brand'}</p>
                            <div style="margin-top: 10px;">
                                <span style="background: ${item.colorHexPrimary || '#333'}; width: 20px; height: 20px; display: inline-block; border-radius: 50%; vertical-align: middle;"></span>
                                <span style="font-size: 0.8em; margin-left: 5px;">${item.colorPrimary}</span>
                            </div>
                            `;
                        grid.appendChild(card);
                    });

                } catch (error) {
                    console.error("Error loading items:", error);
                    grid.innerHTML = `< p class="error-message" > Error loading items: ${ error.message }</p >`;
                }
            }

            applyBtn.addEventListener('click', loadItems);
        });
    </script>
</body>

</html>